/* 1.1.8 2025-03-14 19:00:52 - Incredibox - Designed with love & passion since 2009 */
const{machineId,machineIdSync}=require("node-machine-id"),{clipboard,ipcMain,app,BrowserWindow,Menu,dialog}=require("electron"),path=require("path"),fs=require("fs");let mainWindow,menu;var langJSON={txt:{quitAppConfirm:"Do you really want to quit Incredibox?"},bt:{quit:"Quit",cancel:"Cancel"}};function createWindow(){(mainWindow=new BrowserWindow({title:"Incredibox",width:1500,height:900,minWidth:1074,minHeight:768,titleBarStyle:"hidden",backgroundColor:"#000000",show:!1,fullscreen:!0,autoHideMenuBar:!0,webPreferences:{devTools:!1,enableRemoteModule:!0,nodeIntegration:!1,preload:path.join(__dirname,"elec-preload.js")}})).webContents.on("devtools-opened",()=>{mainWindow.webContents.closeDevTools()}),mainWindow.loadFile(path.join(__dirname,"index.html")),mainWindow.on("close",e=>{app.quitting||(e.preventDefault(),"darwin"===process.platform?dialog.showMessageBox(mainWindow,{type:"question",title:"Confirm",buttons:[langJSON.bt.quit,langJSON.bt.cancel],cancelId:1,defaultId:0,message:langJSON.txt.quitAppConfirm}).then(e=>{0===e.response&&(mainWindow.destroy(),app.quit())}).catch(e=>{}):(mainWindow.destroy(),app.quit()))}),mainWindow.once("ready-to-show",()=>{null!=mainWindow&&mainWindow.show()}),mainWindow.on("closed",function(){})}function initGlobalVars(){process.env.IS_FULLSCREENABLE=mainWindow.isFullScreenable(),process.env.IS_MINIMIZABLE=mainWindow.isMinimizable(),process.env.LANG=app.getLocale(),process.env.UUID=machineIdSync({original:!0}),process.env.ARG=app.commandLine.getSwitchValue("arg"),process.env.USER=JSON.stringify(getUser())}function initIPC(){ipcMain.on("close",()=>mainWindow.close()),ipcMain.on("enterFullScreen",()=>mainWindow.setFullScreen(!0)),ipcMain.on("leaveFullScreen",()=>mainWindow.setFullScreen(!1)),ipcMain.on("loadLang",(e,n)=>{langJSON=n}),ipcMain.on("openURL",(e,n)=>{require("electron").shell.openExternal(n)}),ipcMain.on("minimize",()=>{mainWindow.isFullScreen()?(mainWindow.once("leave-full-screen",()=>mainWindow.minimize()),mainWindow.setFullScreen(!1)):mainWindow.minimize()}),ipcMain.handle("clipboard",(e,i)=>new Promise((e,n)=>{clipboard.writeText(i),clipboard.readText()==i?e():n("clipboard bug")})),ipcMain.on("isFullScreen",e=>e.returnValue=mainWindow.isFullScreen()),ipcMain.on("readUserFile",(n,e)=>{e.file&&0!==e.file.trim().length&&[".txt",".json"].includes(path.extname(e.file).toLowerCase())||(n.returnValue={msg:"file name problem"});var i=path.join(app.getPath("userData"),e.path),i=path.join(i,e.file);fs.existsSync(i)||(n.returnValue={msg:"File not found: "+i});try{n.returnValue={ok:1,msg:"File found: "+i,data:JSON.parse(fs.readFileSync(i,"utf8"))}}catch(e){n.returnValue={msg:"Error file: "+i}}}),ipcMain.on("writeUserFile",(n,e)=>{e.file&&0!==e.file.trim().length&&[".txt",".json"].includes(path.extname(e.file).toLowerCase())||(n.returnValue={msg:"file name problem"});var i=path.join(app.getPath("userData"),e.path);if(!fs.existsSync(i))try{fs.mkdirSync(i)}catch(e){n.returnValue={msg:"Impossible to write directory: "+i}}i=path.join(i,e.file),e=JSON.stringify(e.data,null,2);try{fs.writeFileSync(i,e,"utf8"),n.returnValue={ok:1,msg:"File saved: "+i}}catch(e){n.returnValue={msg:"Impossible to write file: "+i}}}),ipcMain.on("deleteUserFile",(n,e)=>{e.file&&0!==e.file.trim().length&&[".txt",".json"].includes(path.extname(e.file).toLowerCase())||(n.returnValue={msg:"file name problem"});var i=path.join(app.getPath("userData"),e.path),e=path.join(i,e.file);if(fs.existsSync(e))try{fs.unlinkSync(e),n.returnValue={ok:1,msg:"File deleted saved: "+e}}catch(e){n.returnValue={msg:"Impossible to delete file: "+i}}else n.returnValue={msg:"File_not found: "+i}})}function buildMenu(){menu=Menu.buildFromTemplate(myMenu),Menu.setApplicationMenu(menu)}app.name="Incredibox",app.on("ready",()=>{createWindow(),initGlobalVars(),initIPC()}),app.on("activate",function(){null===mainWindow?createWindow():mainWindow.show()}),app.on("before-quit",()=>{app.quitting=!0}),app.on("window-all-closed",function(){});const myMenu=[{role:"window",submenu:[{role:"zoom"},{role:"togglefullscreen"},{type:"separator"},{role:"minimize"},{role:"close"}]},{label:"Edit",submenu:[{role:"undo"},{role:"redo"},{type:"separator"},{role:"cut"},{role:"copy"},{role:"paste"},{role:"delete"},{role:"selectall"}]}];function getUser(){var e="darwin"==process.platform?__dirname:process.env&&process.env.PORTABLE_EXECUTABLE_DIR?process.env.PORTABLE_EXECUTABLE_DIR:"";if((e="darwin"!=process.platform?e.replace(/[\\/]+/g,"/"):e).includes("/steamapps/")){e=e.split("steamapps/")[0]+"config/";try{return extractUserInfo(fs.readFileSync(e+"loginusers.vdf","utf8"))}catch(e){}}return{id:null,name:null}}function extractUserInfo(e){for(var n,i=/"(\d+)"\s*\{\s*[^}]*"PersonaName"\s*"([^"]+)"\s*[^}]*"MostRecent"\s*"(\d)"/g,o=[];null!==(n=i.exec(e));)o.push({id:n[1],name:n[2],mostRecent:n[3]});return o.length?o.find(e=>"1"===e.mostRecent):{id:null,name:null}}"darwin"===process.platform&&myMenu.unshift({label:app.name,submenu:[{role:"about"},{type:"separator"},{role:"hide"},{role:"hideothers"},{role:"unhide"},{type:"separator"},{role:"quit"}]});